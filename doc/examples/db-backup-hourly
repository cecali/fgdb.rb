#!/bin/bash
backup_dir=/usr/local/backup/
sql_dump=$backup_dir/database.sql.gz
export GZIP="--rsyncable"

/usr/sbin/logrotate -f $backup_dir/database_logrotate.conf

su - postgres -c "nice pg_dump -X use-set-session-authorization -C fgdb_production | nice gzip > $sql_dump"

su - postgres -c "nice /usr/bin/rsync -WHqzae \
  'ssh -2 -i /var/lib/postgresql/.ssh/backup_transfer_key' --bwlimit 4096\
  --delete-excluded $backup_dir 'postgres@tulip:/usr/local/arik/'"
