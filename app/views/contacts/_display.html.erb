<% @contact = contact %>
<% options.merge!(:controller => '/contacts', :action => "view", :id => @contact.send("#{Contact.primary_key}")) %>

<div class="contact_display">
  <div class="id">
    <%= ( @contact.contact_types.map {|c_t|
            h(c_t.description)
          }.sort << (@contact.is_organization ? 'organization' : 'person')
          ).join(', ') %>
    (id: <%= @contact.id %><%= ", login: #{h @contact.user.login}" if @contact.user %>)
  </div>
  <div class="name"><%= h @contact.display_name %></div>
  <br />
  <% if @contact.is_person? %>
    <div class="hours_type">
      <%= render :partial => 'hours' %>
  </div>
  <br />
<% end %>
<div class="address"><%= h @contact.address %><br />
  <%= h @contact.city %>, <%= h @contact.state_or_province %> <%= h @contact.postal_code %>
</div>
<div class="contact_methods">
  <% for method in @contact.contact_methods %>
    <%= h method.display %><br />
  <% end %>
</div>
<% if @contact.notes && @contact.notes != '' %>
  <div class="contact_comments">
    Notes:<br />
    <%= h(@contact.notes).gsub(/\n/, "<br />") %>
  </div>
<% end %>
<% checked_since = @contact.spec_sheets_since_last_adoption("checker").length %>
<% built_since = @contact.spec_sheets_since_last_adoption("builder").length %>

<% if (checked_since + built_since) > 0 %>
<div>
Computers QAed since last adoption: <%= checked_since %><br/>
Computers Built since last adoption: <%= built_since %><br/>
</div>
<% end %>

<% str = @contact.scheduled_shifts %>
<% if !str.blank? %>
<div>
Scheduled Volunteer Shifts:<br/>
<%= str %><br />
</div>
<% end %>

<% attends = @contact.assignments.select{|x| x.attended? and x.volunteer_shift.class_credit}.map{|x| x.volunteer_shift.volunteer_event}.map{|x| x.description + " on " + x.date.strftime("%D")}.join(", ") %>
<% if !attends.blank? %>
Attended Classes:<br />
<%= attends %><br />
<% end %>

<% if options.fetch(:display_associations, true) %>
  <div class="associations">
    <% recent_purchases = @contact.get_recent_sale_totals() -%>
    <% unless recent_purchases[:total].nil? -%>
      <div class="sale">
        90 day purchase total: $<%= format("%d.%02d", *recent_purchases[:total].to_i().divmod(100)) %>
      </div>
    <% end -%>
    <% for txn,intro in [["sale", "purchases"],
                         ["disbursement", "disbursements"],
                         ["donation", "donations"],
                         ["gizmo_returns", "returns"]] %>
      <% last_one = @contact.send("last_#{(txn).pluralize}") %>
      <% unless last_one.empty?() %>
        <div class="<%= txn %>">
          recent <%= link_to(intro,
                             :controller => (txn).pluralize,
                             :action => "search",
                             "conditions[contact_id]" => @contact.id,
                             "conditions[contact_enabled]" => "true"
                             ) %>
    : <%= last_one.map{|d,c| "#{h c} #{h d}"}.join(", ") %>
  </div>
<% end %>
<% end %>
<% end %>
<% if coveredness_enabled %>
  <%=
     "Fully Covered: " +
       case @contact.fully_covered
       when nil: "UNKNOWN"
       when true: "Yes"
       when false: "No"
       end
 %>
</div>
<% end %>
<br />
<% if options.fetch(:display_edit, true) %>
  <% edit_options = options.merge(:action => 'edit') %>
  <%= loading_indicator_tag("contact_#{@contact.id}_loading") %>
  <%= my_lightwindow_tag(
                         :content => image_tag(
                                               "edit.png",
                                               :title => "Edit this contact",
                                               :alt => "Edit"
                                               ),
                         :id => contact_edit_link_id(options),
                         :url => edit_options)
      %>
<% end %>
<% if @delete_enabled %>
  <% delete_options = options.merge(:action => 'destroy') %>
  <%= link_to_remote "Delete",
      { :url => delete_options,
        :confirm => 'Are REALLY you sure you want to kill this person?',
        :loading => "Element.show('#{loading_indicator_id("contact_#{contact.id}_loading")}');" } %>
<% end %>
<div id="contact__default_discount_schedule" style="display: none"><%= @contact.default_discount_schedule.id %></div>
<div id="contact__contract" style="display: none"><%= @contact.contract.id %></div>
<div id="contact__shift_count" style="display: none"><%= @contact.assignments.on_or_after_today.not_cancelled.length %></div>
</div>

<%= javascript_tag(options[:on_display]) if options.has_key? :on_display %>
