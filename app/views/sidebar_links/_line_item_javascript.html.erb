<script>
  var gizmo_line_item_id = <%= defined?(@lines) ? @lines.length : 0 %>;
  function sales_stuff(args, tr){
    tr.appendChild(make_hidden("line", "unit_price", args['unit_price'], args['unit_price'], gizmo_line_item_id));
    td = document.createElement("td");
    td.appendChild(make_hidden("line", "total_price", "$0.00", "$0.00", gizmo_line_item_id));
    tr.appendChild(td);
  }

  function gizmo_events_stuff(args, tr){
    var gizmo_type_id = args['gizmo_type_id'];
    var gizmo_type = gizmo_types[gizmo_type_id];
    var gizmo_count = args['gizmo_count'];
    tr.appendChild(make_hidden("line", "gizmo_type_id", gizmo_type, gizmo_type_id, gizmo_line_item_id));
    tr.appendChild(make_hidden("line", "gizmo_count", gizmo_count, gizmo_count, gizmo_line_item_id));
  }

  function do_it(args, hook1, hook2){
    tr = document.createElement("tr");
    tr.className = "line";
    tr.id = 'line_' + gizmo_line_item_id + '_line';
    hook1(args, tr);
    hook2(args, tr);
    td = document.createElement("td");
    a = document.createElement("a");
    a.onclick = new Function('Element.remove(\'line_' + gizmo_line_item_id + '_line\');')
    a.appendChild(document.createTextNode('x'));
    td.appendChild(a);
    tr.appendChild(td);
    $('line_items').lastChild.insertBefore(tr, $('line_items').lastChild.lastChild.previousSibling);
    gizmo_line_item_id += 1;
    compute_total_price_and_payment();
  }

  function make_hidden(container, name, display_value, value, line_id){
    hidden = document.createElement("input");
    hidden.name = container + '[-' + line_id + '][' + name + ']';
    hidden.value = value;
    hidden.type = 'hidden';
    td = document.createElement("td");
    td.className = name;
    td.appendChild(hidden);
    td.appendChild(document.createTextNode(display_value));
    return td;
  }
  function add_sale_gizmo_event()
  {
    if($('unit_price').value == '' || $('gizmo_count').value == '') {
      return true;
    }
    args = new Array();
    args['gizmo_type_id'] = $('gizmo_type_id').value;
    args['unit_price'] = $('unit_price').value;
    args['gizmo_count'] = $('gizmo_count').value;
    do_it(args, gizmo_events_stuff, sales_stuff);
    $('gizmo_type_id').selectedIndex = 0; //should be default, but it's yucky
    $('unit_price').value = $('unit_price').defaultValue;
    $('gizmo_count').value = $('gizmo_count').defaultValue;
    $('gizmo_type_id').focus();
    return false;
  }

  function cent_value(node, id) {
    var value = node.getElementsBySelector(id).first().lastChild.data.replace(/\$/, '');
    var arr = value.split(".");
    if (arr.length > 0) {
      value = parseInt(arr[0]) * 100;
      if (arr.length > 1) {
        if (arr[1].length == 1) {
          value += parseInt(arr[1]) * 10;
        }
        else {
          value += parseInt(arr[1]);
        }
      }
    }
    return value;
  }

  function dollar_value(cents) {
    cents = "" + cents;
    if (cents.length == 0) {
      return "0.00";
    }
    else if (cents.length == 1) {
      return "0.0" + cents;
    } 
    else if (cents.length == 2) {
      return "0." + cents;
    }
    else {
      return cents.replace(/(\d\d)$/, ".$1");
    }
  }

  function node_value(node, id) {
    return parseInt(node.getElementsBySelector(id).first().lastChild.data.replace(/\$/, ''));
  }

  function get_grand_total(){
    var total = 0;
    var arr = $('line_items').getElementsBySelector("tr.line");
    for (var x = 0; x < arr.length; x++) {
      total += cent_value(arr[x], "td.total_price");
    }
    return total;
  }

  function get_subtotal() {
    var total = 0;
    var arr = $('line_items').getElementsBySelector("tr.line");
    for (var x = 0; x < arr.length; x++) {
      total += (cent_value(arr[x], "td.gizmo_count") * node_value(arr[x], "td.unit_price"));
    }
    return total;
  }

  function get_total_payment() {
    var total = 0;
    var arr = $('payment_lines').getElementsBySelector("tr.line");
    for (var x = 0; x < arr.length; x++) {
      total += cent_value(arr[x], "td.amount");
    }
    return total;
  }

  function update_gizmo_events_totals() {
    gizmo_events = $('line_items').getElementsBySelector(".line");
    for (var i = 0; i < gizmo_events.length; i++)
    {
      thing = gizmo_events[i];

      var multiplier = (discount_schedules[$('sale_discount_schedule_id').value][parseInt(thing.getElementsBySelector(".gizmo_type_id").first().firstChild.value)]);
      var amount_b4_discount = (Math.floor(parseInt(thing.getElementsBySelector(".unit_price").first().firstChild.value)*100) * Math.floor(thing.getElementsBySelector(".gizmo_count").first().firstChild.value));
      var amount = multiplier * amount_b4_discount;
      if (isNaN(amount))
          amount = 0;
      amount = Math.floor(amount)/100.0;
      var mystring = "$" + amount;
      thing.getElementsBySelector(".total_price").first().innerHTML = mystring;
    }
  }

  function compute_total_price_and_payment() {
    update_gizmo_events_totals();
    var subtotal = get_subtotal();
    var grand_total = get_grand_total();
    var discount = subtotal - grand_total;
    var payment = get_total_payment();
    var overpayment = payment - grand_total;

    $('subtotal').innerHTML = dollar_value(subtotal);
    $('discount').innerHTML = dollar_value(discount);
    $('grand_total').innerHTML = dollar_value(grand_total);
    if (overpayment > 0) {
      $('overpayment').innerHTML = dollar_value(overpayment);
      $('overpayment').parentNode.style.display = "normal";
    }
    else {
      $('overpayment').parentNode.style.display = "none";
    }
  }
</script>

<% if ["sales", "donations", "recyclings", "disbursements"].include?(params[:controller]) %>
  <% js = "var gizmo_types = new Array;" %>
  <% for gizmo_type in @gizmo_context.gizmo_types.sort_by(&:description) %>
    <% js += "gizmo_types[#{gizmo_type.id}] = '#{gizmo_type.description}';" %>
  <% end %>
  <%= javascript_tag js %>
<% end %>

<script>
  function payment_stuff(tr, args){
    var payment_amount = args['payment_amount'];
    var payment_method_id = args['payment_method_id'];
    tr.appendChild(make_hidden("payments", "payment_method_id", payment_methods[payment_method_id], payment_method_id, payment_method_id));
    amount_node = make_hidden("payments", "amount", payment_amount, payment_amount, payment_method_id);
    amount_node.className = "amount";
    tr.appendChild(amount_node);
  }

  var payment_line_id = <%= defined?(@payment_lines) ? @payment_lines.length : 0 %>;
  function add_payment(args) {
    tr = document.createElement("tr");
    tr.className = "line";
    tr.id = 'payment_' + payment_line_id + '_line';
    payment_stuff(tr, args);
    td = document.createElement("td");
    a = document.createElement("a");
    a.onclick = new Function('Element.remove(\'payment_' + payment_line_id + '_line\');')
    a.appendChild(document.createTextNode('x'));
    td.appendChild(a);
    tr.appendChild(td);
    $('payment_lines').lastChild.insertBefore(tr, $('payment_lines').lastChild.lastChild.previousSibling);
    payment_line_id++;
    compute_total_price_and_payment();
  }

  function add_payment_from_form() {
    if($('payment_amount').value == '') {
      return true;
    }
    args = new Array();
    args['payment_method_id'] = $('payment_method_id').value;
    args['payment_amount'] = $('payment_amount').value;
    add_payment(args);
    $('payment_method_id').selectedIndex = 0; //should be default, but it's yucky
    $('payment_amount').value = $('payment_amount').defaultValue;
    $('payment_method_id').focus();
    return false;
  }
</script>

<% if ["sales", "donations"].include?(params[:controller]) %>
  <% js = "var payment_methods = new Array;" %>
  <% for payment_method in PaymentMethod.find(:all).sort_by(&:description) %>
    <% js += "payment_methods[#{payment_method.id}] = '#{payment_method.description}';" %>
  <% end %>
  <%= javascript_tag js %>
<% end %>
